<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Vault 🔒</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            --orange: #f97316;
            --orange-dark: #ea580c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f3f4f6;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .tab-btn {
            flex: 1;
            padding: 1rem;
            background: grey;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-btn:not(:last-child) {
            border-right: 1px solid var(--gray-light);
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        select, input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 1rem;
        }

        select {
            color: var(--dark);
            background-color: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* Only style the empty/disabled options */
        select option[value=""][disabled] {
            color: #9ca3af;
            font-style: italic;
        }

        /* Regular options should be normal */
        select option {
            color: var(--dark);
            font-style: normal;
        }

        /* Style for when no selection is made */
        select:invalid {
            color: #9ca3af;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        button {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: var(--primary-dark);
        }
        
        button.secondary {
            background: var(--gray);
        }
        
        button.success {
            background: var(--success);
        }
        
        button.danger {
            background: var(--danger);
        }
        
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #b91c1c;
        }
        
        .password-field {
            position: relative;
        }
        
        .password-field input {
            padding-right: 6rem;
        }
        
        .password-actions {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--gray);
            padding: 0.25rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s ease;
        }
        
        .btn-icon:hover {
            color: var(--primary);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .card-title {
            font-weight: 600;
            color: var(--dark);
        }

        select option[value=""] {
            color: #9ca3af;  /* Gray color */
            font-style: italic;
        }

        .delete-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .confirm-delete {
            display: flex;
            align-items: center;
            height: 44px; /* Match button height */
            padding: 0 1.5rem;
            background: white;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-weight: 600;
            margin: 0;
        }

        .confirm-delete input[type="checkbox"] {
            width: auto;
            margin: 0 0.5rem 0 0;
            padding: 0;
        }

        .result-card {
            background: #f0fdf4;  /* Light green background */
            border: 1px solid #86efac;  /* Success border color */
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .result-card .card-header {
            border-bottom-color: #86efac;
            margin-bottom: 1.5rem;
        }

        .result-card .card-title {
            color: #166534;  /* Dark green text */
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .result-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .result-label {
            font-weight: 600;
            color: #166534;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-new {
            background: var(--orange);
        }

        .btn-new:hover {
            background: var(--orange-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Password Vault 🔒</h1>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="search">Search</button>
            <button class="tab-btn" data-tab="create">Create</button>
            <button class="tab-btn" data-tab="update">Update</button>
            <button class="tab-btn" data-tab="delete">Delete</button>
        </div>
        
        <div id="alerts"></div>
        
        <!-- Search Tab -->
        <div id="search" class="tab-content active">
            <div class="form-group">
                <label for="search-title">Title:</label>
                <select id="search-title"></select>
            </div>
            
            <div class="form-group">
                <label for="search-username">Username:</label>
                <select id="search-username"></select>
            </div>
            
            <div id="search-result" class="grid" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Other</span>
                    </div>
                    <div id="search-url"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Password</span>
                    </div>
                    <div class="password-field">
                        <input type="password" id="search-password" readonly>
                        <div class="password-actions">
                            <button class="btn-icon" id="toggle-search-password" title="Toggle visibility">👁️</button>
                            <button class="btn-icon" id="copy-search-password" title="Copy to clipboard">📋</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create Tab -->
        <div id="create" class="tab-content">
            <form id="create-form">
                <div class="form-group">
                    <label for="create-title">Title (required):</label>
                    <input type="text" id="create-title" required>
                </div>
                
                <div class="form-group">
                    <label for="create-username">Username (required):</label>
                    <input type="text" id="create-username" required>
                </div>
                
                <div class="form-group">
                    <label for="create-url">Other (optional):</label>
                    <input type="text" id="create-url" placeholder="N/A">
                </div>
                
                <div class="form-group">
                    <label for="create-password">Password (leave blank to autogenerate):</label>
                    <div class="password-field">
                        <input type="password" id="create-password">
                        <div class="password-actions">
                            <button type="button" class="btn-icon" id="toggle-create-password" title="Toggle visibility">👁️</button>
                            <button type="button" class="btn-icon" id="copy-create-password" title="Copy to clipboard" style="display: none;">📋</button>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit">Create</button>
                    <button type="button" id="new-entry" class="btn-new" style="display: none;">New Entry</button>
                </div>
            </form>
            
            <div id="create-result" style="display: none; margin-top: 2rem;">
                <div class="alert alert-success">Password created successfully!</div>
            </div>
        </div>

        
        <!-- Update Tab -->
        <div id="update" class="tab-content">
            <div class="form-group">
                <label for="update-title">Title:</label>
                <select id="update-title"></select>
            </div>
            
            <div class="form-group">
                <label for="update-username">Username:</label>
                <select id="update-username"></select>
            </div>
            
            <form id="update-form" style="margin-top: 2rem;">
                <div class="form-group">
                    <label for="update-url">Other:</label>
                    <input type="text" id="update-url">
                </div>
                
                <div class="form-group">
                    <label for="update-password">Password (leave blank to autogenerate):</label>
                    <div class="password-field">
                        <input type="password" id="update-password">
                        <div class="password-actions">
                            <button type="button" class="btn-icon" id="toggle-update-password" title="Toggle visibility">👁️</button>
                        </div>
                    </div>
                </div>
                
                <button type="submit">Update</button>
            </form>
            
            <div id="update-result" style="display: none;">
                <div class="result-card"><div class="alert alert-success">Entry updated successfully!</div>
                    <div class="result-grid">
                        <div class="result-item">
                            <span class="result-label">Old Other</span>
                            <div id="old-url"></div>
                        </div>
                        <div class="result-item">
                            <span class="result-label">New Other</span>
                            <div id="new-url"></div>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Old Password</span>
                            <div class="password-field">
                                <input type="password" id="old-password" readonly>
                                <div class="password-actions">
                                    <button class="btn-icon" id="toggle-old-password" title="Toggle visibility">👁️</button>
                                    <button class="btn-icon" id="copy-old-password" title="Copy to clipboard">📋</button>
                                </div>
                            </div>
                        </div>
                        <div class="result-item">
                            <span class="result-label">New Password</span>
                            <div class="password-field">
                                <input type="password" id="new-password" readonly>
                                <div class="password-actions">
                                    <button class="btn-icon" id="toggle-new-password" title="Toggle visibility">👁️</button>
                                    <button class="btn-icon" id="copy-new-password" title="Copy to clipboard">📋</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Delete Tab -->
        <div id="delete" class="tab-content">
            <div class="form-group">
                <label for="delete-title">Title:</label>
                <select id="delete-title"></select>
            </div>
            
            <div class="form-group">
                <label for="delete-username">Username:</label>
                <select id="delete-username"></select>
            </div>
            
            <div class="delete-actions">
                <label class="confirm-delete">
                    <input type="checkbox" id="delete-confirm">
                    Confirm Deletion
                </label>
                <button id="delete-btn" class="danger">Delete</button>
            </div>

            <div id="delete-result" style="display: none; margin-top: 2rem;">
                <div class="alert alert-success">Password entry deleted successfully!</div>
            </div>
        </div>
    </div>
    
    <script>
        const BACKEND_URL = "http://localhost:8000";
        let titles = [];
        let entriesByTitle = {};
        
        // Tab switching logic
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and contents
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked button and its content
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
        
        // Helper functions
        function showAlert(message, type = 'success') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            // Remove alert after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function togglePasswordVisibility(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).catch(
                err => {console.error('Could not copy text: ', err);}
            );
        }
        
        // Fetch all titles
        async function fetchTitles() {
            try {
                const response = await fetch(`${BACKEND_URL}/titles/`);
                if (!response.ok) throw new Error('Failed to fetch titles');
                
                titles = await response.json();
                
                // Populate title dropdowns while preserving selection
                const titleSelects = ['search-title', 'update-title', 'delete-title'];
                titleSelects.forEach(id => {
                    const select = document.getElementById(id);
                    const currentValue = select.value; // Store current selection
                    
                    // Store the related username selection before updating
                    const usernameId = id.replace('title', 'username');
                    const usernameSelect = document.getElementById(usernameId);
                    const currentUsername = usernameSelect.value;
                    
                    select.innerHTML = '';
                    
                    // Add default empty option with disabled attribute
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- Select Title --';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    select.appendChild(defaultOption);
                    
                    titles.forEach(title => {
                        const option = document.createElement('option');
                        option.value = title;
                        option.textContent = title;
                        select.appendChild(option);
                    });
                    
                    // Restore previous selection if it exists
                    if (currentValue && titles.includes(currentValue)) {
                        select.value = currentValue;
                        // Only fetch entries if we had a previous title selection
                        fetchEntries(currentValue, currentUsername);
                    }
                });
            } catch (error) {
                console.error('Error fetching titles:', error);
                showAlert('Error fetching titles: ' + error.message, 'danger');
            }
        }
        
        // Fetch entries for a title
        async function fetchEntries(title, preserveUsername = null) {
            try {
                const response = await fetch(`${BACKEND_URL}/passwords/${title}`);
                if (!response.ok) throw new Error('Failed to fetch entries');
                
                entriesByTitle[title] = await response.json();
                
                // Populate username dropdowns
                const usernameSelects = {
                    'search-title': 'search-username',
                    'update-title': 'update-username',
                    'delete-title': 'delete-username'
                };
                
                Object.entries(usernameSelects).forEach(([titleId, usernameId]) => {
                    if (document.getElementById(titleId).value === title) {
                        const select = document.getElementById(usernameId);
                        select.innerHTML = '';
                        
                        // Add default empty option with disabled attribute
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '-- Select Username --';
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                        select.appendChild(defaultOption);
                        
                        entriesByTitle[title].forEach(entry => {
                            const option = document.createElement('option');
                            option.value = entry.username;
                            option.textContent = entry.username;
                            select.appendChild(option);
                        });
                        
                        // Restore username if provided and exists in options
                        if (preserveUsername && entriesByTitle[title].some(entry => entry.username === preserveUsername)) {
                            select.value = preserveUsername;
                            // Trigger change event if username was restored
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                });
            } catch (error) {
                console.error(`Error fetching entries for ${title}:`, error);
                showAlert(`Error fetching entries: ${error.message}`, 'danger');
            }
        }
        
        // Fetch a single entry
        async function fetchEntry(title, username) {
            try {
                const response = await fetch(`${BACKEND_URL}/passwords/${title}/${username}`);
                if (!response.ok) throw new Error('Failed to fetch entry');
                
                return await response.json();
            } catch (error) {
                console.error(`Error fetching entry ${title}/${username}:`, error);
                showAlert(`Error fetching entry: ${error.message}`, 'danger');
                return null;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch initial data
            fetchTitles();
            
            // Setup event listeners for title changes
            ['search-title', 'update-title', 'delete-title'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    const title = e.target.value;
                    if (title && (!entriesByTitle[title] || entriesByTitle[title].length === 0)) {
                        fetchEntries(title);
                    } else if (entriesByTitle[title]) {
                        // Repopulate username dropdown
                        const usernameId = id.replace('title', 'username');
                        const select = document.getElementById(usernameId);
                        select.innerHTML = '';
                        
                        entriesByTitle[title].forEach(entry => {
                            const option = document.createElement('option');
                            option.value = entry.username;
                            option.textContent = entry.username;
                            select.appendChild(option);
                        });
                        
                        // Trigger change event
                        select.dispatchEvent(new Event('change'));
                    }
                });
            });
            
            // Search functionality - Modified section
            async function updateSearchResults() {
                const title = document.getElementById('search-title').value;
                const username = document.getElementById('search-username').value;
                
                if (!title || !username) {
                    document.getElementById('search-result').style.display = 'none';
                    return;
                }

                try {
                    // First ensure we have the latest entries for this title
                    if (!entriesByTitle[title] || entriesByTitle[title].length === 0) {
                        await fetchEntries(title);
                    }

                    // Check if the username exists in our cached entries
                    const cachedEntry = entriesByTitle[title]?.find(entry => entry.username === username);
                    if (!cachedEntry) {
                        document.getElementById('search-result').style.display = 'none';
                        return;
                    }

                    // Now fetch the specific entry
                    const entry = await fetchEntry(title, username);
                    if (entry) {
                        document.getElementById('search-url').textContent = entry.url;
                        document.getElementById('search-password').value = entry.password;
                        document.getElementById('search-result').style.display = 'grid';
                    } else {
                        document.getElementById('search-result').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error updating search results:', error);
                    document.getElementById('search-result').style.display = 'none';
                }
            }

            // Replace the event listeners for search
            document.getElementById('search-title').addEventListener('change', async (e) => {
                const title = e.target.value;
                if (title) {
                    await fetchEntries(title); // Wait for entries to be fetched
                    updateSearchResults();
                } else {
                    document.getElementById('search-result').style.display = 'none';
                }
            });

            document.getElementById('search-username').addEventListener('change', updateSearchResults);

            // Create functionality
            document.getElementById('create-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('create-title').value;
                const username = document.getElementById('create-username').value;
                const url = document.getElementById('create-url').value || 'N/A';
                const password = document.getElementById('create-password').value;
                const generate = !password;
                
                if (!title || !username) {
                    showAlert('Title and username are required.', 'danger');
                    return;
                }
                
                try {
                    const response = await fetch(`${BACKEND_URL}/passwords/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title,
                            username,
                            url,
                            password,
                            generate
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    const result = await response.json();
                    
                    // Update the password field with the generated password
                    document.getElementById('create-password').value = result.password;
                    
                    // Show the copy button
                    document.getElementById('copy-create-password').style.display = 'block';
                    
                    // Show success message
                    document.getElementById('create-result').style.display = 'block';
                    
                    // Show the new entry button after successful creation
                    document.getElementById('new-entry').style.display = 'block';
                    
                    // Preserve current selections before refreshing
                    const currentSelections = {};
                    ['search', 'update', 'delete'].forEach(tab => {
                        currentSelections[tab] = {
                            title: document.getElementById(`${tab}-title`).value,
                            username: document.getElementById(`${tab}-username`).value
                        };
                    });
                    
                    // Refresh the title dropdowns and update entries
                    await fetchTitles();
                    
                    // Restore selections
                    Object.entries(currentSelections).forEach(([tab, selection]) => {
                        if (selection.title) {
                            const titleSelect = document.getElementById(`${tab}-title`);
                            titleSelect.value = selection.title;
                            fetchEntries(selection.title, selection.username);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error creating password:', error);
                    showAlert(`Error creating password: ${error.message}`, 'danger');
                }
            });

            // Add New Entry button handler
            document.getElementById('new-entry').addEventListener('click', () => {
                // Clear all form fields
                document.getElementById('create-title').value = '';
                document.getElementById('create-username').value = '';
                document.getElementById('create-url').value = '';
                document.getElementById('create-password').value = '';
                
                // Hide copy button
                document.getElementById('copy-create-password').style.display = 'none';
                
                // Hide success message
                document.getElementById('create-result').style.display = 'none';
                
                // Focus on the title field
                document.getElementById('create-title').focus();
            });
            
            // Update functionality
            document.getElementById('update-username').addEventListener('change', async (e) => {
                const title = document.getElementById('update-title').value;
                const username = e.target.value;
                
                if (title && username) {
                    const entry = await fetchEntry(title, username);
                    if (entry) {
                        document.getElementById('update-url').value = entry.url;
                        document.getElementById('update-password').value = entry.password;
                    }
                }
            });
            
            document.getElementById('update-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('update-title').value;
                const username = document.getElementById('update-username').value;
                const url = document.getElementById('update-url').value;
                const password = document.getElementById('update-password').value;
                const generate = !password;
                
                if (!title || !username) {
                    showAlert('Title and username are required.', 'danger');
                    return;
                }
                
                try {
                    // Get current entry for comparison later
                    const oldEntry = await fetchEntry(title, username);
                    
                    const response = await fetch(`${BACKEND_URL}/passwords/`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title,
                            username,
                            url,
                            password,
                            generate
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    const result = await response.json();
                    
                    // Update result display
                    document.getElementById('old-url').textContent = oldEntry.url;
                    document.getElementById('new-url').textContent = result.url;
                    document.getElementById('old-password').value = oldEntry.password;
                    document.getElementById('new-password').value = result.password;
                    document.getElementById('update-result').style.display = 'grid';
                    
                    // Refresh entries while preserving the username selection
                    await fetchEntries(title, username);
                } catch (error) {
                    console.error('Error updating password:', error);
                    showAlert(`Error updating password: ${error.message}`, 'danger');
                }
            });
            
            // Delete functionality
            document.getElementById('delete-btn').addEventListener('click', async () => {
                const title = document.getElementById('delete-title').value;
                const username = document.getElementById('delete-username').value;
                const confirmed = document.getElementById('delete-confirm').checked;
                
                if (!title || !username) {
                    showAlert('Title and username are required.', 'danger');
                    return;
                }
                
                if (!confirmed) {
                    showAlert('Please confirm deletion.', 'danger');
                    return;
                }
                
                try {
                    const response = await fetch(`${BACKEND_URL}/passwords/${title}/${username}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    // Show the success message in the dedicated area
                    document.getElementById('delete-result').style.display = 'block';
                    
                    // Hide the message after 5 seconds
                    setTimeout(() => {
                        document.getElementById('delete-result').style.display = 'none';
                    }, 5000);
                    
                    // Clear all cached entries to force a fresh fetch
                    entriesByTitle = {};

                    // First check if there are any remaining entries for this title
                    const checkResponse = await fetch(`${BACKEND_URL}/passwords/${title}`);
                    if (checkResponse.ok) {
                        // Title still exists, refresh entries for all tabs
                        await fetchEntries(title);
                        // Update all dropdowns that have this title selected
                        ['search-title', 'update-title', 'delete-title'].forEach(id => {
                            if (document.getElementById(id).value === title) {
                                document.getElementById(id).dispatchEvent(new Event('change'));
                            }
                        });
                    } else {
                        // Title no longer exists, refresh all dropdowns
                        await fetchTitles();
                        
                        // Reset all username dropdowns
                        ['search-username', 'update-username', 'delete-username'].forEach(id => {
                            const select = document.getElementById(id);
                            select.innerHTML = '';
                            const defaultOption = document.createElement('option');
                            defaultOption.value = '';
                            defaultOption.textContent = '-- Select Username --';
                            defaultOption.disabled = true;
                            defaultOption.selected = true;
                            select.appendChild(defaultOption);
                        });

                        // Hide any results that might be showing
                        document.getElementById('search-result').style.display = 'none';
                    }
                    
                    // Reset confirmation
                    document.getElementById('delete-confirm').checked = false;
                } catch (error) {
                    console.error('Error deleting password:', error);
                    showAlert(`Error deleting password: ${error.message}`, 'danger');
                }
            });
            
            // Toggle password visibility
            const passwordToggles = [
                ['search-password', 'toggle-search-password'],
                ['create-password', 'toggle-create-password'],
                ['created-password', 'toggle-created-password'],
                ['update-password', 'toggle-update-password'],
                ['old-password', 'toggle-old-password'],
                ['new-password', 'toggle-new-password']
            ];
            
            passwordToggles.forEach(([inputId, buttonId]) => {
                document.getElementById(buttonId)?.addEventListener('click', () => {
                    togglePasswordVisibility(inputId, buttonId);
                });
            });
            
            // Copy password to clipboard
            const copyButtons = [
                ['search-password', 'copy-search-password'],
                ['created-password', 'copy-created-password'],
                ['old-password', 'copy-old-password'],
                ['new-password', 'copy-new-password']
            ];
            
            copyButtons.forEach(([inputId, buttonId]) => {
                document.getElementById(buttonId)?.addEventListener('click', () => {
                    const password = document.getElementById(inputId).value;
                    copyToClipboard(password);
                });
            });

            // Make sure selects have the required attribute
            ['search-title', 'search-username', 'update-title', 'update-username', 'delete-title', 'delete-username'].forEach(id => {
                document.getElementById(id).required = true;
            });
        });
    </script>
</body>
</html>